{
  "lexicon": 1,
  "id": "at.margin.annotation",
  "revision": 2,
  "description": "W3C Web Annotation Data Model compliant annotation record for ATProto",
  "defs": {
    "main": {
      "type": "record",
      "description": "A W3C-compliant web annotation stored on the AT Protocol",
      "key": "tid",
      "record": {
        "type": "object",
        "required": ["target", "createdAt"],
        "properties": {
          "motivation": {
            "type": "string",
            "description": "W3C motivation for the annotation",
            "knownValues": [
              "commenting",
              "highlighting",
              "bookmarking",
              "tagging",
              "describing",
              "linking",
              "replying",
              "editing",
              "questioning",
              "assessing"
            ]
          },
          "body": {
            "type": "ref",
            "ref": "#body",
            "description": "The annotation content (text or reference)"
          },
          "target": {
            "type": "ref",
            "ref": "#target",
            "description": "The resource being annotated with optional selector"
          },
          "tags": {
            "type": "array",
            "description": "Tags for categorization",
            "items": {
              "type": "string",
              "maxLength": 64,
              "maxGraphemes": 32
            },
            "maxLength": 10
          },
          "createdAt": {
            "type": "string",
            "format": "datetime"
          }
        }
      }
    },
    "body": {
      "type": "object",
      "description": "Annotation body - the content of the annotation",
      "properties": {
        "value": {
          "type": "string",
          "maxLength": 10000,
          "maxGraphemes": 3000,
          "description": "Text content of the annotation"
        },
        "format": {
          "type": "string",
          "description": "MIME type of the body content",
          "default": "text/plain"
        },
        "language": {
          "type": "string",
          "description": "BCP47 language tag"
        },
        "uri": {
          "type": "string",
          "format": "uri",
          "description": "Reference to external body content"
        }
      }
    },
    "target": {
      "type": "object",
      "description": "W3C SpecificResource - the target with optional selector",
      "required": ["source"],
      "properties": {
        "source": {
          "type": "string",
          "format": "uri",
          "description": "The URL being annotated"
        },
        "sourceHash": {
          "type": "string",
          "description": "SHA256 hash of normalized URL for indexing"
        },
        "title": {
          "type": "string",
          "maxLength": 500,
          "description": "Page title at time of annotation"
        },
        "selector": {
          "type": "union",
          "description": "Selector to identify the specific segment",
          "refs": [
            "#textQuoteSelector",
            "#textPositionSelector",
            "#cssSelector",
            "#xpathSelector",
            "#fragmentSelector",
            "#rangeSelector"
          ]
        },
        "state": {
          "type": "ref",
          "ref": "#timeState",
          "description": "State of the resource at annotation time"
        }
      }
    },
    "textQuoteSelector": {
      "type": "object",
      "description": "W3C TextQuoteSelector - select text by quoting it with context",
      "required": ["exact"],
      "properties": {
        "type": {
          "type": "string",
          "const": "TextQuoteSelector"
        },
        "exact": {
          "type": "string",
          "maxLength": 5000,
          "maxGraphemes": 1500,
          "description": "The exact text to match"
        },
        "prefix": {
          "type": "string",
          "maxLength": 500,
          "maxGraphemes": 150,
          "description": "Text immediately before the selection"
        },
        "suffix": {
          "type": "string",
          "maxLength": 500,
          "maxGraphemes": 150,
          "description": "Text immediately after the selection"
        }
      }
    },
    "textPositionSelector": {
      "type": "object",
      "description": "W3C TextPositionSelector - select by character offsets",
      "required": ["start", "end"],
      "properties": {
        "type": {
          "type": "string",
          "const": "TextPositionSelector"
        },
        "start": {
          "type": "integer",
          "minimum": 0,
          "description": "Starting character position (0-indexed, inclusive)"
        },
        "end": {
          "type": "integer",
          "minimum": 0,
          "description": "Ending character position (exclusive)"
        }
      }
    },
    "cssSelector": {
      "type": "object",
      "description": "W3C CssSelector - select DOM elements by CSS selector",
      "required": ["value"],
      "properties": {
        "type": {
          "type": "string",
          "const": "CssSelector"
        },
        "value": {
          "type": "string",
          "maxLength": 2000,
          "description": "CSS selector string"
        }
      }
    },
    "xpathSelector": {
      "type": "object",
      "description": "W3C XPathSelector - select by XPath expression",
      "required": ["value"],
      "properties": {
        "type": {
          "type": "string",
          "const": "XPathSelector"
        },
        "value": {
          "type": "string",
          "maxLength": 2000,
          "description": "XPath expression"
        }
      }
    },
    "fragmentSelector": {
      "type": "object",
      "description": "W3C FragmentSelector - select by URI fragment",
      "required": ["value"],
      "properties": {
        "type": {
          "type": "string",
          "const": "FragmentSelector"
        },
        "value": {
          "type": "string",
          "maxLength": 1000,
          "description": "Fragment identifier value"
        },
        "conformsTo": {
          "type": "string",
          "format": "uri",
          "description": "Specification the fragment conforms to"
        }
      }
    },
    "rangeSelector": {
      "type": "object",
      "description": "W3C RangeSelector - select range between two selectors",
      "required": ["startSelector", "endSelector"],
      "properties": {
        "type": {
          "type": "string",
          "const": "RangeSelector"
        },
        "startSelector": {
          "type": "union",
          "description": "Selector for range start",
          "refs": [
            "#textQuoteSelector",
            "#textPositionSelector",
            "#cssSelector",
            "#xpathSelector"
          ]
        },
        "endSelector": {
          "type": "union",
          "description": "Selector for range end",
          "refs": [
            "#textQuoteSelector",
            "#textPositionSelector",
            "#cssSelector",
            "#xpathSelector"
          ]
        }
      }
    },
    "timeState": {
      "type": "object",
      "description": "W3C TimeState - record when content was captured",
      "properties": {
        "sourceDate": {
          "type": "string",
          "format": "datetime",
          "description": "When the source was accessed"
        },
        "cached": {
          "type": "string",
          "format": "uri",
          "description": "URL to cached/archived version"
        }
      }
    }
  }
}
